{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.5.1644",
      "templateHash": "14929642687382823729"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources"
      }
    },
    "environmentName": {
      "type": "string",
      "defaultValue": "env-eureka-crawler",
      "metadata": {
        "description": "Name of the existing Container Apps Environment (from Eureka deployment)"
      }
    },
    "uamiName": {
      "type": "string",
      "defaultValue": "uami-eureka-crawler",
      "metadata": {
        "description": "Name of the existing User-Assigned Managed Identity (from Eureka deployment)"
      }
    },
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "Name of the existing Azure Key Vault (from Eureka deployment)"
      }
    },
    "acrName": {
      "type": "string",
      "metadata": {
        "description": "Name of the existing Azure Container Registry (from Eureka deployment)"
      }
    },
    "cosmosAccountName": {
      "type": "string",
      "metadata": {
        "description": "Name of the existing Cosmos DB account (from Eureka deployment)"
      }
    },
    "jobBackfillName": {
      "type": "string",
      "defaultValue": "nsa-backfill",
      "metadata": {
        "description": "Name of the NSA backfill job"
      }
    },
    "jobDeltaName": {
      "type": "string",
      "defaultValue": "nsa-delta",
      "metadata": {
        "description": "Name of the NSA delta job"
      }
    },
    "imageName": {
      "type": "string",
      "defaultValue": "nsa-crawler",
      "metadata": {
        "description": "Container image name in ACR"
      }
    },
    "imageTag": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "Container image tag"
      }
    },
    "cpu": {
      "type": "string",
      "defaultValue": "1.0",
      "metadata": {
        "description": "CPU cores for job containers"
      }
    },
    "memory": {
      "type": "string",
      "defaultValue": "2Gi",
      "metadata": {
        "description": "Memory for job containers"
      }
    },
    "cronExpression": {
      "type": "string",
      "defaultValue": "10 5 * * *",
      "metadata": {
        "description": "CRON expression for delta job schedule (UTC timezone)"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases",
      "apiVersion": "2023-11-15",
      "name": "[format('{0}/{1}', parameters('cosmosAccountName'), 'nsa')]",
      "properties": {
        "resource": {
          "id": "nsa"
        }
      }
    },
    {
      "type": "Microsoft.App/jobs",
      "apiVersion": "2023-05-01",
      "name": "[parameters('jobBackfillName')]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName')))]": {}
        }
      },
      "properties": {
        "environmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('environmentName'))]",
        "configuration": {
          "triggerType": "Manual",
          "replicaTimeout": 86400,
          "replicaRetryLimit": 3,
          "manualTriggerConfig": {
            "parallelism": 1,
            "replicaCompletionCount": 1
          },
          "secrets": [
            {
              "name": "cosmos-connection-string",
              "keyVaultUrl": "[format('{0}secrets/cosmos-connection-string', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri)]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
            },
            {
              "name": "sharepoint-tenant-id",
              "keyVaultUrl": "[format('{0}secrets/sharepoint-tenant-id', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri)]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
            },
            {
              "name": "sharepoint-client-id",
              "keyVaultUrl": "[format('{0}secrets/sharepoint-client-id', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri)]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
            },
            {
              "name": "sharepoint-client-secret",
              "keyVaultUrl": "[format('{0}secrets/sharepoint-client-secret', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri)]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
            },
            {
              "name": "sharepoint-site-id",
              "keyVaultUrl": "[format('{0}secrets/sharepoint-site-id', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri)]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
            },
            {
              "name": "sharepoint-drive-id",
              "keyVaultUrl": "[format('{0}secrets/sharepoint-drive-id', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri)]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
            }
          ]
        },
        "template": {
          "containers": [
            {
              "name": "nsa-crawler-backfill",
              "image": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
              "resources": {
                "cpu": "[json(parameters('cpu'))]",
                "memory": "[parameters('memory')]"
              },
              "env": [
                {
                  "name": "MODE",
                  "value": "backfill"
                },
                {
                  "name": "Nsa__BackfillStartDate",
                  "value": "2024-01-01"
                },
                {
                  "name": "Nsa__BackfillEndDate",
                  "value": "2024-12-31"
                },
                {
                  "name": "Nsa__DeltaWindowDays",
                  "value": "14"
                },
                {
                  "name": "Nsa__SixMonthRuleMonths",
                  "value": "6"
                },
                {
                  "name": "Nsa__Limits__RequestsPerMinute",
                  "value": "10"
                },
                {
                  "name": "Nsa__Limits__RequestsPerHour",
                  "value": "100"
                },
                {
                  "name": "Nsa__Limits__MinDelayMs",
                  "value": "2000"
                },
                {
                  "name": "Nsa__Limits__MaxDelayMs",
                  "value": "5000"
                },
                {
                  "name": "Cosmos__Database",
                  "value": "nsa"
                },
                {
                  "name": "Cosmos__DecisionsCollection",
                  "value": "decisions"
                },
                {
                  "name": "Cosmos__PendingJustificationsCollection",
                  "value": "pending_justifications"
                },
                {
                  "name": "Cosmos__FailedDocumentsCollection",
                  "value": "failed_documents"
                },
                {
                  "name": "Cosmos__FailedSharePointUploadsCollection",
                  "value": "failed_sharepoint_uploads"
                },
                {
                  "name": "Cosmos__RateLimiterStateCollection",
                  "value": "rate_limiter_state"
                },
                {
                  "name": "Cosmos__CreateIndexesOnStart",
                  "value": "true"
                },
                {
                  "name": "Cosmos__ConnectionString",
                  "secretRef": "cosmos-connection-string"
                },
                {
                  "name": "SharePoint__Enabled",
                  "value": "true"
                },
                {
                  "name": "SharePoint__FolderFormat",
                  "value": "yyyyMM"
                },
                {
                  "name": "SharePoint__BaseFolder",
                  "value": "NSA_docs"
                },
                {
                  "name": "SharePoint__TenantId",
                  "secretRef": "sharepoint-tenant-id"
                },
                {
                  "name": "SharePoint__ClientId",
                  "secretRef": "sharepoint-client-id"
                },
                {
                  "name": "SharePoint__ClientSecret",
                  "secretRef": "sharepoint-client-secret"
                },
                {
                  "name": "SharePoint__SiteId",
                  "secretRef": "sharepoint-site-id"
                },
                {
                  "name": "SharePoint__DriveId",
                  "secretRef": "sharepoint-drive-id"
                },
                {
                  "name": "Conversion__LibreOfficePath",
                  "value": "/usr/bin/soffice"
                },
                {
                  "name": "Conversion__TimeoutSeconds",
                  "value": "120"
                },
                {
                  "name": "Conversion__TempDirectory",
                  "value": "/tmp/nsa-conversion"
                },
                {
                  "name": "Logging__LogLevel__Default",
                  "value": "Information"
                },
                {
                  "name": "Logging__LogLevel__Microsoft.Hosting.Lifetime",
                  "value": "Information"
                },
                {
                  "name": "Logging__LogLevel__NSA.Crawler",
                  "value": "Debug"
                }
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts/mongodbDatabases', parameters('cosmosAccountName'), 'nsa')]"
      ]
    },
    {
      "type": "Microsoft.App/jobs",
      "apiVersion": "2023-05-01",
      "name": "[parameters('jobDeltaName')]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName')))]": {}
        }
      },
      "properties": {
        "environmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('environmentName'))]",
        "configuration": {
          "triggerType": "Schedule",
          "replicaTimeout": 3600,
          "replicaRetryLimit": 2,
          "scheduleTriggerConfig": {
            "cronExpression": "[parameters('cronExpression')]",
            "parallelism": 1,
            "replicaCompletionCount": 1
          },
          "secrets": [
            {
              "name": "cosmos-connection-string",
              "keyVaultUrl": "[format('{0}secrets/cosmos-connection-string', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri)]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
            },
            {
              "name": "sharepoint-tenant-id",
              "keyVaultUrl": "[format('{0}secrets/sharepoint-tenant-id', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri)]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
            },
            {
              "name": "sharepoint-client-id",
              "keyVaultUrl": "[format('{0}secrets/sharepoint-client-id', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri)]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
            },
            {
              "name": "sharepoint-client-secret",
              "keyVaultUrl": "[format('{0}secrets/sharepoint-client-secret', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri)]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
            },
            {
              "name": "sharepoint-site-id",
              "keyVaultUrl": "[format('{0}secrets/sharepoint-site-id', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri)]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
            },
            {
              "name": "sharepoint-drive-id",
              "keyVaultUrl": "[format('{0}secrets/sharepoint-drive-id', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri)]",
              "identity": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
            }
          ]
        },
        "template": {
          "containers": [
            {
              "name": "nsa-crawler-delta",
              "image": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
              "resources": {
                "cpu": "[json(parameters('cpu'))]",
                "memory": "[parameters('memory')]"
              },
              "env": [
                {
                  "name": "MODE",
                  "value": "delta"
                },
                {
                  "name": "Nsa__BackfillStartDate",
                  "value": "2024-01-01"
                },
                {
                  "name": "Nsa__BackfillEndDate",
                  "value": "2024-12-31"
                },
                {
                  "name": "Nsa__DeltaWindowDays",
                  "value": "14"
                },
                {
                  "name": "Nsa__SixMonthRuleMonths",
                  "value": "6"
                },
                {
                  "name": "Nsa__Limits__RequestsPerMinute",
                  "value": "10"
                },
                {
                  "name": "Nsa__Limits__RequestsPerHour",
                  "value": "100"
                },
                {
                  "name": "Nsa__Limits__MinDelayMs",
                  "value": "2000"
                },
                {
                  "name": "Nsa__Limits__MaxDelayMs",
                  "value": "5000"
                },
                {
                  "name": "Cosmos__Database",
                  "value": "nsa"
                },
                {
                  "name": "Cosmos__DecisionsCollection",
                  "value": "decisions"
                },
                {
                  "name": "Cosmos__PendingJustificationsCollection",
                  "value": "pending_justifications"
                },
                {
                  "name": "Cosmos__FailedDocumentsCollection",
                  "value": "failed_documents"
                },
                {
                  "name": "Cosmos__FailedSharePointUploadsCollection",
                  "value": "failed_sharepoint_uploads"
                },
                {
                  "name": "Cosmos__RateLimiterStateCollection",
                  "value": "rate_limiter_state"
                },
                {
                  "name": "Cosmos__CreateIndexesOnStart",
                  "value": "true"
                },
                {
                  "name": "Cosmos__ConnectionString",
                  "secretRef": "cosmos-connection-string"
                },
                {
                  "name": "SharePoint__Enabled",
                  "value": "true"
                },
                {
                  "name": "SharePoint__FolderFormat",
                  "value": "yyyyMM"
                },
                {
                  "name": "SharePoint__BaseFolder",
                  "value": "NSA_docs"
                },
                {
                  "name": "SharePoint__TenantId",
                  "secretRef": "sharepoint-tenant-id"
                },
                {
                  "name": "SharePoint__ClientId",
                  "secretRef": "sharepoint-client-id"
                },
                {
                  "name": "SharePoint__ClientSecret",
                  "secretRef": "sharepoint-client-secret"
                },
                {
                  "name": "SharePoint__SiteId",
                  "secretRef": "sharepoint-site-id"
                },
                {
                  "name": "SharePoint__DriveId",
                  "secretRef": "sharepoint-drive-id"
                },
                {
                  "name": "Conversion__LibreOfficePath",
                  "value": "/usr/bin/soffice"
                },
                {
                  "name": "Conversion__TimeoutSeconds",
                  "value": "120"
                },
                {
                  "name": "Conversion__TempDirectory",
                  "value": "/tmp/nsa-conversion"
                },
                {
                  "name": "Logging__LogLevel__Default",
                  "value": "Information"
                },
                {
                  "name": "Logging__LogLevel__Microsoft.Hosting.Lifetime",
                  "value": "Information"
                },
                {
                  "name": "Logging__LogLevel__NSA.Crawler",
                  "value": "Debug"
                }
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts/mongodbDatabases', parameters('cosmosAccountName'), 'nsa')]"
      ]
    }
  ],
  "outputs": {
    "jobBackfillName": {
      "type": "string",
      "value": "[parameters('jobBackfillName')]"
    },
    "jobDeltaName": {
      "type": "string",
      "value": "[parameters('jobDeltaName')]"
    },
    "cosmosDatabaseName": {
      "type": "string",
      "value": "nsa"
    },
    "fullImageUrl": {
      "type": "string",
      "value": "[format('{0}/{1}:{2}', reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), '2023-07-01').loginServer, parameters('imageName'), parameters('imageTag'))]"
    },
    "updateJobBackfillCommand": {
      "type": "string",
      "value": "[format('az containerapp job update -n {0} -g {1} --image {2}/{3}:{4} --registry-server {5} --registry-identity {6}', parameters('jobBackfillName'), resourceGroup().name, reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), '2023-07-01').loginServer, parameters('imageName'), parameters('imageTag'), reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), '2023-07-01').loginServer, resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName')))]"
    },
    "updateJobDeltaCommand": {
      "type": "string",
      "value": "[format('az containerapp job update -n {0} -g {1} --image {2}/{3}:{4} --registry-server {5} --registry-identity {6}', parameters('jobDeltaName'), resourceGroup().name, reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), '2023-07-01').loginServer, parameters('imageName'), parameters('imageTag'), reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), '2023-07-01').loginServer, resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName')))]"
    }
  }
}